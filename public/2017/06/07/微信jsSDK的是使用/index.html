<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    

    <title>
      如何使用微信的jsSDK | 扑通扑通&#39;s blog 
    </title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
      <meta name="author" content="扑通扑通">
    
    

    <meta name="description" content="前言现在的微信用户太强大了，公司的一些运营的活动啊，总是希望能够定制微信的自定义分享，但是需要jsSDK，我们又没做公众号开发，只能闲暇的时候看看怎么弄了。以前还能投机取巧些说分享图片取第一张图片，现在微信升级之后，好像是在6.8.5版本之后，如果不及接入jsSDK的话，就默认使用微信官方的一个锁的那个默认图，怎么说呢，体验会不是很好。 申请微信公众号公众号分什么订阅号，服务号，个人号，企业号，不">
<meta name="keywords" content="微信 jsSDK">
<meta property="og:type" content="article">
<meta property="og:title" content="如何使用微信的jsSDK | 扑通扑通&#39;s blog">
<meta property="og:url" content="http://AshaLiu.github.io/2017/06/07/微信jsSDK的是使用/index.html">
<meta property="og:site_name" content="扑通扑通&#39;s blog">
<meta property="og:description" content="前言现在的微信用户太强大了，公司的一些运营的活动啊，总是希望能够定制微信的自定义分享，但是需要jsSDK，我们又没做公众号开发，只能闲暇的时候看看怎么弄了。以前还能投机取巧些说分享图片取第一张图片，现在微信升级之后，好像是在6.8.5版本之后，如果不及接入jsSDK的话，就默认使用微信官方的一个锁的那个默认图，怎么说呢，体验会不是很好。 申请微信公众号公众号分什么订阅号，服务号，个人号，企业号，不">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-07-06T02:47:58.330Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="如何使用微信的jsSDK | 扑通扑通&#39;s blog">
<meta name="twitter:description" content="前言现在的微信用户太强大了，公司的一些运营的活动啊，总是希望能够定制微信的自定义分享，但是需要jsSDK，我们又没做公众号开发，只能闲暇的时候看看怎么弄了。以前还能投机取巧些说分享图片取第一张图片，现在微信升级之后，好像是在6.8.5版本之后，如果不及接入jsSDK的话，就默认使用微信官方的一个锁的那个默认图，怎么说呢，体验会不是很好。 申请微信公众号公众号分什么订阅号，服务号，个人号，企业号，不">
    
    
    
      <link rel="icon" type="image/x-icon" href="/favicon.png">
    
    <link rel="stylesheet" href="/css/uno.css">
    <link rel="stylesheet" href="/css/highlight.css">
    <link rel="stylesheet" href="/css/archive.css">
    <link rel="stylesheet" href="/css/china-social-icon.css">

</head>
<body>

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    

<header class="panel-cover panel-cover--collapsed">


  <div class="panel-main">

  
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        

        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">扑通扑通&#39;s blog</a></h1>
        <hr class="panel-cover__divider">

        

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">

              
                
                <li class="navigation__item"><a href="/#blog" title="" class="blog-button">首页</a></li>
              
                
                <li class="navigation__item"><a href="/about" title="" class="">关于</a></li>
              
                
                <li class="navigation__item"><a href="/archive" title="" class="">归档</a></li>
              

            </ul>
          </nav>

          <!-- ----------------------------
To add a new social icon simply duplicate one of the list items from below
and change the class in the <i> tag to match the desired social network
and then add your link to the <a>. Here is a full list of social network
classes that you can use:

    icon-social-500px
    icon-social-behance
    icon-social-delicious
    icon-social-designer-news
    icon-social-deviant-art
    icon-social-digg
    icon-social-dribbble
    icon-social-facebook
    icon-social-flickr
    icon-social-forrst
    icon-social-foursquare
    icon-social-github
    icon-social-google-plus
    icon-social-hi5
    icon-social-instagram
    icon-social-lastfm
    icon-social-linkedin
    icon-social-medium
    icon-social-myspace
    icon-social-path
    icon-social-pinterest
    icon-social-rdio
    icon-social-reddit
    icon-social-skype
    icon-social-spotify
    icon-social-stack-overflow
    icon-social-steam
    icon-social-stumbleupon
    icon-social-treehouse
    icon-social-tumblr
    icon-social-twitter
    icon-social-vimeo
    icon-social-xbox
    icon-social-yelp
    icon-social-youtube
    icon-social-zerply
    icon-mail

-------------------------------->

<!-- add social info here -->



        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner entry">
            

<article class="post-container post-container--single">

  <header class="post-header">
    
    <h1 class="post-title">如何使用微信的jsSDK</h1>

    

    <div class="post-meta">
      <time datetime="2017-06-07" class="post-meta__date date">2017-06-07</time> 

      <span class="post-meta__tags tags">

          

          
             &#8226; 标签:
            <font class="tags">
              <a class="tags-link" href="/tags/微信-jsSDK/">微信 jsSDK</a>
            </font>
          

      </span>
    </div>
    
    

  </header>

  <section id="post-content" class="article-content post">
    <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>现在的微信用户太强大了，公司的一些运营的活动啊，总是希望能够定制微信的自定义分享，但是需要<code>jsSDK</code>，我们又没做公众号开发，只能闲暇的时候看看怎么弄了。<br>以前还能投机取巧些说分享图片取第一张图片，现在微信升级之后，好像是在6.8.5版本之后，如果不及接入jsSDK的话，就默认使用微信官方的一个锁的那个默认图，怎么说呢，体验会不是很好。</p>
<h3 id="申请微信公众号"><a href="#申请微信公众号" class="headerlink" title="申请微信公众号"></a>申请微信公众号</h3><p>公众号分什么订阅号，服务号，个人号，企业号，不同需求不同功能嘛，都有开发者模式。但是我作为个人开发者是申请不到服务号的，怎么办呢，腾讯微我们准备了测试账号，通过这个账号，我们可以获得微信服务号的所有功能和接口调用权限。<br><a href="http://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login" target="_blank" rel="noopener">申请地址</a><br>申请之后你会拿到一个<code>appid</code>和<code>appsecret</code>，这个其实差不多就是你的公众号的秘钥一样，在拿<code>access_token</code>需要用到的。</p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>其实微信<a href="https://mp.weixin.qq.com/advanced/wiki?t=t=resource/res_main&amp;id=mp1421140183" target="_blank" rel="noopener">官方文档</a>说的很清楚。<br>微信是一个app，我们h5是一个网页，那我们怎么在app里面分享、拍照上传等动作呢，这时候就需要一个h5和app的桥，叫jsSDK。那使用这个jsSDK的前提是什么？</p>
<h4 id="步骤一：绑定域名"><a href="#步骤一：绑定域名" class="headerlink" title="步骤一：绑定域名"></a>步骤一：绑定域名</h4><p>登录微信公众平台进入“公众号设置”的“功能设置”里填写“JS接口安全域名”。<br>备注：登录后可在“开发者中心”查看对应的接口权限。<br>测试账号的话直接拉倒下面就可以看到填写得地方了。注意，我这里卡了好久。首先，先解释下什么叫二级域名<br>这里我举个例子就能明白了：</p>
<ul>
<li>.com 顶级域名</li>
<li>baidu.com 一级域名</li>
<li><a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a> 二级域名</li>
<li>bbs.baidu .com 二级域名</li>
<li>tieba.baidu .com 二级域名</li>
</ul>
<p>设置js安全域名后，公众号开发者可以在该域名下调用微信的jsSDK，js接口的安全域名要求是一级或一级以上，可以填写三个。<br>如果调用js的域名是二级域名，而在JS接口安全域名里面没有配置该二级域名，那么可以直接配置成主域名。比如二级域名是weixin.test.com,那么JS接口安全域名可以配置成test.com<br>我个人建议是填写一级域名，因为这么多的运营活动，你才三个坑。<br>另外截止到现在为止，公众平台接口调用仅支持80端口。</p>
<h4 id="步骤二：引入JS文件"><a href="#步骤二：引入JS文件" class="headerlink" title="步骤二：引入JS文件"></a>步骤二：引入JS文件</h4><p>在需要调用JS接口的页面引入如下JS文件，（支持https）：<a href="http://res.wx.qq.com/open/js/jweixin-1.2.0.js" target="_blank" rel="noopener">http://res.wx.qq.com/open/js/jweixin-1.2.0.js</a><br>备注：支持使用 AMD/CMD 标准模块加载方法加载</p>
<h4 id="步骤三：通过config接口注入权限验证配置"><a href="#步骤三：通过config接口注入权限验证配置" class="headerlink" title="步骤三：通过config接口注入权限验证配置"></a>步骤三：通过config接口注入权限验证配置</h4><p>所有需要使用JS-SDK的页面必须先注入配置信息，否则将无法调用（同一个url仅需调用一次，对于变化url的SPA的web app可在每次url变化时进行调用,目前Android微信客户端不支持pushState的H5新特性，所以使用pushState来实现web app的页面会导致签名失败，此问题会在Android6.2中修复）。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wx.config(&#123;</span><br><span class="line">    debug: <span class="literal">true</span>, <span class="comment">// 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。</span></span><br><span class="line">    appId: <span class="string">''</span>, <span class="comment">// 必填，公众号的唯一标识</span></span><br><span class="line">    timestamp: <span class="string">''</span>, <span class="comment">// 必填，生成签名的时间戳</span></span><br><span class="line">    nonceStr: <span class="string">''</span>, <span class="comment">// 必填，生成签名的随机串</span></span><br><span class="line">    signature: <span class="string">''</span>,<span class="comment">// 必填，签名</span></span><br><span class="line">    jsApiList: [] <span class="comment">// 必填，需要使用的JS接口列表，所有JS接口列表</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>等等，上面的这些啥玩意儿？<br><code>appId</code>就是上面提到的，timestamp时间戳自己生成的，nonceStr一个随机字符串自己生成的，signature签名，这怎么来？</p>
<h5 id="签名算法"><a href="#签名算法" class="headerlink" title="签名算法"></a>签名算法</h5><p>签名生成规则如下：<br>参与签名的字段包括<code>noncestr</code>（随机字符串）, 有效的<code>jsapi_ticket</code>, <code>timestamp</code>（时间戳）, <code>url</code>（当前网页的URL，不包含#及其后面部分） 。<br>对所有待签名参数按照字段名的ASCII 码从小到大排序（字典序）后，使用URL键值对的格式（即key1=value1&amp;key2=value2…）拼接成字符串string1。<br>这里需要注意的是所有参数名均为小写字符。对string1作sha1加密，字段名和字段值都采用原始值，不进行URL 转义。<br>即<code>signature=sha1(string1)</code>。 示例：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> noncestr = <span class="string">'Wm3WZYTPz0wzccnW'</span>;</span><br><span class="line"> jsapi_ticket = <span class="string">'sM4AOVdWfPE4DxkXGEs8VMCPGGVi4C3VM0P37wVUCFvkVAy_90u5h9nbSlYy3-Sl-HhTdfl2fzFy1AOcHKP7qg'</span>;</span><br><span class="line"> timestamp = <span class="string">'1414587457'</span>;</span><br><span class="line"> url = <span class="string">'http://mp.weixin.qq.com?params=value'</span>;</span><br><span class="line"><span class="string">``</span><span class="string">` </span></span><br><span class="line"><span class="string">步骤1.  </span></span><br><span class="line"><span class="string">    对所有待签名参数按照字段名的ASCII 码从小到大排序（字典序）后，使用URL键值对的格式（即key1=value1&amp;key2=value2…）拼接成字符串string1：</span></span><br><span class="line"><span class="string">    jsapi_ticket=sM4AOVdWfPE4DxkXGEs8VMCPGGVi4C3VM0P37wVUCFvkVAy_90u5h9nbSlYy3-Sl-HhTdfl2fzFy1AOcHKP7qg&amp;noncestr=Wm3WZYTPz0wzccnW&amp;timestamp=1414587457&amp;url=http://mp.weixin.qq.com?params=value  </span></span><br><span class="line"><span class="string">步骤2.  </span></span><br><span class="line"><span class="string">    对string1进行sha1签名，得到signature：0f9de62fce790f9a083d5c99e95740ceb90c27ed  </span></span><br><span class="line"><span class="string">注意事项  </span></span><br><span class="line"><span class="string">   - 签名用的noncestr和timestamp必须与wx.config中的nonceStr和timestamp相同。  </span></span><br><span class="line"><span class="string">   - 签名用的url必须是调用JS接口页面的完整URL。</span></span><br><span class="line"><span class="string">   - 出于安全考虑，开发者必须在服务器端实现签名的逻辑。  </span></span><br><span class="line"><span class="string">`</span>jsapi_ticket<span class="string">`又是啥？</span></span><br><span class="line"><span class="string">##### jsapi_ticket</span></span><br><span class="line"><span class="string">`</span>jsapi_ticket<span class="string">`是公众号用于调用微信JS接口的临时票据。  </span></span><br><span class="line"><span class="string">正常情况下，`</span>jsapi_ticket<span class="string">`的有效期为7200秒，通过`</span>access_token<span class="string">`来获取。  </span></span><br><span class="line"><span class="string">由于获取`</span>jsapi_ticket<span class="string">`的`</span>api<span class="string">`调用次数非常有限，频繁刷新`</span>jsapi_ticket<span class="string">`会导致`</span>api<span class="string">`调用受限，影响自身业务，开发者必须在自己的服务全局缓存`</span>jsapi_ticket<span class="string">` 。  </span></span><br><span class="line"><span class="string">说白了就是调用下微信的接口，`</span>https:<span class="comment">//api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=ACCESS_TOKEN&amp;type=jsapi`  ，`GET请求`，它会给你你需要的`jsapi_ticket`。</span></span><br><span class="line"><span class="string">``</span><span class="string">`javascript</span></span><br><span class="line"><span class="string">//返回的json数据示例</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "errcode": 0,</span></span><br><span class="line"><span class="string">    "errmsg": "ok",</span></span><br><span class="line"><span class="string">    "ticket": "bxLdikRXVbTPdHSM05e5u5sUoXNKd8-41ZO3MhKoyN5OfkWITDGgnr2fwJ0m9E8NYzWKVZvdVtaUgWvsdshFKA",</span></span><br><span class="line"><span class="string">    "expires_in": 7200</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p><code>access_token</code>又是啥？</p>
<h5 id="access-token"><a href="#access-token" class="headerlink" title="access_token"></a>access_token</h5><p>access_token是公众号的全局唯一接口调用凭据，公众号调用各接口时都需使用access_token。<br>开发者需要进行妥善保存。access_token的存储至少要保留512个字符空间。<br>access_token的有效期目前为2个小时，需定时刷新，重复获取将导致上次获取的access_token失效。  </p>
<p><em>公众平台的API调用所需的access_token的使用及生成方式说明： </em> </p>
<ul>
<li>建议公众号开发者使用中控服务器统一获取和刷新Access_token，其他业务逻辑服务器所使用的access_token均来自于该中控服务器，不应该各自去刷新，否则容易造成冲突，导致access_token覆盖而影响业务；</li>
<li>目前Access_token的有效期通过返回的expire_in来传达，目前是7200秒之内的值。中控服务器需要根据这个有效时间提前去刷新新access_token。在刷新过程中，中控服务器对外输出的依然是老access_token，此时公众平台后台会保证在刷新短时间内，新老access_token都可用，这保证了第三方业务的平滑过渡；</li>
<li>Access_token的有效时间可能会在未来有调整，所以中控服务器不仅需要内部定时主动刷新，还需要提供被动刷新access_token的接口，这样便于业务服务器在API调用获知access_token已超时的情况下，可以触发access_token的刷新流程。</li>
</ul>
<p>其实也是请求微信的一个接口：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID&amp;secret=APPSECRET</span></span><br><span class="line"><span class="comment">* 请求方式 GET</span></span><br><span class="line"><span class="comment">* 参数 grant_type    获取access_token填写client_credential</span></span><br><span class="line"><span class="comment">* 参数 appid		    第三方用户唯一凭证</span></span><br><span class="line"><span class="comment">* 参数 secret		第三方用户唯一凭证密钥，即appsecret</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">正常的返回json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"access_token"</span>:<span class="string">"ACCESS_TOKEN"</span>,</span><br><span class="line">    <span class="string">"expires_in"</span>:<span class="number">7200</span></span><br><span class="line">&#125;</span><br><span class="line">失败的返回json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"errcode"</span>:<span class="number">40013</span>,</span><br><span class="line">    <span class="string">"errmsg"</span>:<span class="string">"invalid appid"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* -1	系统繁忙，此时请开发者稍候再试]</span></span><br><span class="line"><span class="comment">* 0	请求成功</span></span><br><span class="line"><span class="comment">* 40001	AppSecret错误或者AppSecret不属于这个公众号，请开发者确认AppSecret的正确性</span></span><br><span class="line"><span class="comment">* 40002	请确保grant_type字段值为client_credential</span></span><br><span class="line"><span class="comment">* 40164 调用接口的IP地址不在白名单中，请在接口IP白名单中进行设置</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></p>
<p>好了，这样一步一步过来就能拿到调用jsSDK需要的必备参数了。完美，皆大欢喜！</p>
<h4 id="步骤四：通过ready接口处理成功验证"><a href="#步骤四：通过ready接口处理成功验证" class="headerlink" title="步骤四：通过ready接口处理成功验证"></a>步骤四：通过ready接口处理成功验证</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wx.ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="步骤五：通过error接口处理失败验证"><a href="#步骤五：通过error接口处理失败验证" class="headerlink" title="步骤五：通过error接口处理失败验证"></a>步骤五：通过error接口处理失败验证</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wx.error(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="接口调用说明"><a href="#接口调用说明" class="headerlink" title="接口调用说明"></a>接口调用说明</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">所有接口通过wx对象(也可使用jWeixin对象)来调用，参数是一个对象，除了每个接口本身需要传的参数之外，还有以下通用参数：</span><br><span class="line"> <span class="number">1.</span> success：接口调用成功时执行的回调函数。</span><br><span class="line"> <span class="number">2.</span> fail：接口调用失败时执行的回调函数。</span><br><span class="line"> <span class="number">3.</span> complete：接口调用完成时执行的回调函数，无论成功或失败都会执行。</span><br><span class="line"> <span class="number">4.</span> cancel：用户点击取消时的回调函数，仅部分有用户取消操作的api才会用到。</span><br><span class="line"> <span class="number">5.</span> trigger: 监听Menu中的按钮点击时触发的方法，该方法仅支持Menu中的相关接口。</span><br><span class="line"> 备注：不要尝试在trigger中使用ajax异步请求修改本次分享的内容，因为客户端分享操作是一个同步操作，这时候使用ajax的回包会还没有返回。</span><br><span class="line"> 以上几个函数都带有一个参数，类型为对象，其中除了每个接口本身返回的数据之外，还有一个通用属性errMsg，其值格式如下：</span><br><span class="line"> 调用成功时：<span class="string">"xxx:ok"</span> ，其中xxx为调用的接口名</span><br><span class="line"> 用户取消时：<span class="string">"xxx:cancel"</span>，其中xxx为调用的接口名</span><br><span class="line"> 调用失败时：其值为具体错误信息</span><br></pre></td></tr></table></figure>
<h3 id="实施"><a href="#实施" class="headerlink" title="实施"></a>实施</h3><p>这个题目，不知道该叫啥，哈哈。<br>之前不是说js安全域名不能填本地的ip嘛，那怎么办，我本地开发，我又是一个前端。我需要服务端的人支持，运维的人支持，服务端的人每次初始化的时候给我签名，时间戳啥啥啥的。<br>但是我又想自己搞清楚，要不然一塌糊涂，做缓存，调接口，我node也可以呀。重要的是我怎么把我的内网地址能让外网访问。<br>之前QQ浏览器自带了一个微信调试这样的一个功能，它其中有个功能就是服务端调试，把你的内网穿透，能映射让外网访问。这样就可以在测试公众号上填写js安全域名了。<br>很可惜，我说的是之前。所以，百度啊百度，百度了一个叫花生壳的工具，有这样的一个功能。  </p>
<p>注册一个账号，并且去申请一个免费的壳域名，设置一下，映射到本地的你起的这个服务的网址上，这样就做到了内网穿透。具体的大家可以百度花生壳内网穿透的教程。<br>做这个的时候还是挺心酸的，我用的是mac，花生壳还没有mac版的客户端，我又跑去找到封尘以久的联想，然后…  </p>
<p>我申请到一个<code>ashasmile.imwork.net</code>，然后在js安全域名填了<code>imwork.net</code>。</p>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>上面的都是一些概念啊，流程啊，下面开始晒代码了啊。</p>
<h4 id="基本配置-config-wechat-config-js"><a href="#基本配置-config-wechat-config-js" class="headerlink" title="基本配置 /config/wechat.config.js"></a>基本配置 /config/wechat.config.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    grant_type: <span class="string">'client_credential'</span>,</span><br><span class="line">    appid: <span class="string">'wx5f87160ac8f64d3d'</span>,</span><br><span class="line">    secret: <span class="string">'ad89c2d17bfeddce0905e6761b42a3d2'</span>,</span><br><span class="line">    noncestr:<span class="string">'Wm3WZYTPz0wzccnW'</span>,</span><br><span class="line">    accessTokenUrl:<span class="string">'https://api.weixin.qq.com/cgi-bin/token'</span>,</span><br><span class="line">    ticketUrl:<span class="string">'https://api.weixin.qq.com/cgi-bin/ticket/getticket'</span>,</span><br><span class="line">    cache_duration:<span class="number">1000</span>*<span class="number">60</span>*<span class="number">60</span>*<span class="number">24</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="生成签名算法-sign-signature-js"><a href="#生成签名算法-sign-signature-js" class="headerlink" title="生成签名算法 /sign/signature.js"></a>生成签名算法 /sign/signature.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> request = <span class="built_in">require</span>(<span class="string">'request'</span>),</span><br><span class="line">    cache = <span class="built_in">require</span>(<span class="string">'memory-cache'</span>),</span><br><span class="line">    sha1 = <span class="built_in">require</span>(<span class="string">'sha1'</span>),</span><br><span class="line">    config = <span class="built_in">require</span>(<span class="string">'../config/wechat.config'</span>);</span><br><span class="line"></span><br><span class="line">exports.sign = <span class="function"><span class="keyword">function</span> (<span class="params">url,callback</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> noncestr = config.noncestr,</span><br><span class="line">        timestamp = <span class="built_in">Math</span>.floor(<span class="built_in">Date</span>.now()/<span class="number">1000</span>), <span class="comment">//精确到秒</span></span><br><span class="line">        jsapi_ticket;</span><br><span class="line">    <span class="keyword">if</span>(cache.get(<span class="string">'ticket'</span>))&#123;</span><br><span class="line">        jsapi_ticket = cache.get(<span class="string">'ticket'</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'1'</span> + <span class="string">'jsapi_ticket='</span> + jsapi_ticket + <span class="string">'&amp;noncestr='</span> + noncestr + <span class="string">'&amp;timestamp='</span> + timestamp + <span class="string">'&amp;url='</span> + url);</span><br><span class="line">        callback(&#123;</span><br><span class="line">            noncestr:noncestr,</span><br><span class="line">            timestamp:timestamp,</span><br><span class="line">            url:url,</span><br><span class="line">            jsapi_ticket:jsapi_ticket,</span><br><span class="line">            signature:sha1(<span class="string">'jsapi_ticket='</span> + jsapi_ticket + <span class="string">'&amp;noncestr='</span> + noncestr + <span class="string">'&amp;timestamp='</span> + timestamp + <span class="string">'&amp;url='</span> + url)</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//获取accessToken</span></span><br><span class="line">        request(config.accessTokenUrl + <span class="string">'?grant_type='</span> + config.grant_type + <span class="string">'&amp;appid='</span> + config.appid + <span class="string">'&amp;secret='</span> + config.secret ,<span class="function"><span class="keyword">function</span>(<span class="params">error, response, body</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!error &amp;&amp; response.statusCode == <span class="number">200</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> tokenMap = <span class="built_in">JSON</span>.parse(body);</span><br><span class="line">                request(config.ticketUrl + <span class="string">'?access_token='</span> + tokenMap.access_token + <span class="string">'&amp;type=jsapi'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">error, resp, json</span>)</span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (!error &amp;&amp; response.statusCode == <span class="number">200</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> ticketMap = <span class="built_in">JSON</span>.parse(json);</span><br><span class="line">                        cache.put(<span class="string">'ticket'</span>,ticketMap.ticket,config.cache_duration);  <span class="comment">//加入缓存</span></span><br><span class="line">                        <span class="built_in">console</span>.log(<span class="string">'jsapi_ticket='</span> + ticketMap.ticket + <span class="string">'&amp;noncestr='</span> + noncestr + <span class="string">'&amp;timestamp='</span> + timestamp + <span class="string">'&amp;url='</span> + url);</span><br><span class="line">                        callback(&#123;</span><br><span class="line">                            noncestr:noncestr,</span><br><span class="line">                            timestamp:timestamp,</span><br><span class="line">                            url:url,</span><br><span class="line">                            jsapi_ticket:ticketMap.ticket,</span><br><span class="line">                            signature:sha1(<span class="string">'jsapi_ticket='</span> + ticketMap.ticket + <span class="string">'&amp;noncestr='</span> + noncestr + <span class="string">'&amp;timestamp='</span> + timestamp + <span class="string">'&amp;url='</span> + url)</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="客户端js-static-index-js"><a href="#客户端js-static-index-js" class="headerlink" title="客户端js  /static/index.js"></a>客户端js  /static/index.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">'refresh'</span>).onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;location.reload();&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  以下内容多摘自官方demo</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//alert(appId + ' ; ' + timestamp + ' ; ' + nonceStr + ' ; ' + signature);</span></span><br><span class="line">wx.config(&#123;</span><br><span class="line">    debug: <span class="literal">true</span>, <span class="comment">// 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。</span></span><br><span class="line">    appId: appId, <span class="comment">// 必填，公众号的唯一标识</span></span><br><span class="line">    timestamp: timestamp, <span class="comment">// 必填，生成签名的时间戳</span></span><br><span class="line">    nonceStr: nonceStr, <span class="comment">// 必填，生成签名的随机串</span></span><br><span class="line">    signature: signature,<span class="comment">// 必填，签名，见附录1</span></span><br><span class="line">    jsApiList: [<span class="string">'checkJsApi'</span>,</span><br><span class="line">        <span class="string">'onMenuShareTimeline'</span>,</span><br><span class="line">        <span class="string">'onMenuShareAppMessage'</span>,</span><br><span class="line">        <span class="string">'onMenuShareQQ'</span>,</span><br><span class="line">        <span class="string">'onMenuShareWeibo'</span>,</span><br><span class="line">        <span class="string">'hideMenuItems'</span>,</span><br><span class="line">        <span class="string">'showMenuItems'</span>,</span><br><span class="line">        <span class="string">'hideAllNonBaseMenuItem'</span>,</span><br><span class="line">        <span class="string">'showAllNonBaseMenuItem'</span>,</span><br><span class="line">        <span class="string">'translateVoice'</span>,</span><br><span class="line">        <span class="string">'startRecord'</span>,</span><br><span class="line">        <span class="string">'stopRecord'</span>,</span><br><span class="line">        <span class="string">'onRecordEnd'</span>,</span><br><span class="line">        <span class="string">'playVoice'</span>,</span><br><span class="line">        <span class="string">'pauseVoice'</span>,</span><br><span class="line">        <span class="string">'stopVoice'</span>,</span><br><span class="line">        <span class="string">'uploadVoice'</span>,</span><br><span class="line">        <span class="string">'downloadVoice'</span>,</span><br><span class="line">        <span class="string">'chooseImage'</span>,</span><br><span class="line">        <span class="string">'previewImage'</span>,</span><br><span class="line">        <span class="string">'uploadImage'</span>,</span><br><span class="line">        <span class="string">'downloadImage'</span>,</span><br><span class="line">        <span class="string">'getNetworkType'</span>,</span><br><span class="line">        <span class="string">'openLocation'</span>,</span><br><span class="line">        <span class="string">'getLocation'</span>,</span><br><span class="line">        <span class="string">'hideOptionMenu'</span>,</span><br><span class="line">        <span class="string">'showOptionMenu'</span>,</span><br><span class="line">        <span class="string">'closeWindow'</span>,</span><br><span class="line">        <span class="string">'scanQRCode'</span>,</span><br><span class="line">        <span class="string">'chooseWXPay'</span>,</span><br><span class="line">        <span class="string">'openProductSpecificView'</span>,</span><br><span class="line">        <span class="string">'addCard'</span>,</span><br><span class="line">        <span class="string">'chooseCard'</span>,</span><br><span class="line">        <span class="string">'openCard'</span>] <span class="comment">// 必填，需要使用的JS接口列表，</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">wx.ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"> <span class="comment">// 1 判断当前版本是否支持指定 JS 接口，支持批量判断</span></span><br><span class="line">  <span class="built_in">document</span>.querySelector(<span class="string">'#checkJsApi'</span>).onclick = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    wx.checkJsApi(&#123;</span><br><span class="line">      jsApiList: [</span><br><span class="line">        <span class="string">'getNetworkType'</span>,</span><br><span class="line">        <span class="string">'previewImage'</span></span><br><span class="line">      ],</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">        alert(<span class="built_in">JSON</span>.stringify(res));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 2. 分享接口</span></span><br><span class="line">  <span class="comment">// 2.1 监听“分享给朋友”，按钮点击、自定义分享内容及分享结果接口</span></span><br><span class="line">  <span class="built_in">document</span>.querySelector(<span class="string">'#onMenuShareAppMessage'</span>).onclick = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    wx.onMenuShareAppMessage(&#123;</span><br><span class="line">      title: <span class="string">'互联网之子'</span>,</span><br><span class="line">      desc: <span class="string">'在长大的过程中，我才慢慢发现，我身边的所有事，别人跟我说的所有事，那些所谓本来如此，注定如此的事，它们其实没有非得如此，事情是可以改变的。更重要的是，有些事既然错了，那就该做出改变。'</span>,</span><br><span class="line">      link: location.href,</span><br><span class="line">      imgUrl: <span class="string">'http://demo.open.weixin.qq.com/jssdk/images/p2166127561.jpg'</span>,</span><br><span class="line">      trigger: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 不要尝试在trigger中使用ajax异步请求修改本次分享的内容，因为客户端分享操作是一个同步操作，这时候使用ajax的回包会还没有返回</span></span><br><span class="line">        alert(<span class="string">'用户点击发送给朋友'</span>);</span><br><span class="line">      &#125;,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">        alert(<span class="string">'已分享'</span>);</span><br><span class="line">      &#125;,</span><br><span class="line">      cancel: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">        alert(<span class="string">'已取消'</span>);</span><br><span class="line">      &#125;,</span><br><span class="line">      fail: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">        alert(<span class="built_in">JSON</span>.stringify(res));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">    alert(<span class="string">'已注册获取“发送给朋友”状态事件'</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5 图片接口</span></span><br><span class="line">  <span class="comment">// 5.1 拍照、本地选图</span></span><br><span class="line">  <span class="keyword">var</span> images = &#123;</span><br><span class="line">    localId: [],</span><br><span class="line">    serverId: []</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="built_in">document</span>.querySelector(<span class="string">'#chooseImage'</span>).onclick = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    wx.chooseImage(&#123;</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">        images.localId = res.localIds;</span><br><span class="line">        alert(<span class="string">'已选择 '</span> + res.localIds.length + <span class="string">' 张图片'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">    <span class="comment">// 5.2 图片预览</span></span><br><span class="line">  <span class="built_in">document</span>.querySelector(<span class="string">'#previewImage'</span>).onclick = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    wx.previewImage(&#123;</span><br><span class="line">      current: <span class="string">'http://img5.douban.com/view/photo/photo/public/p1353993776.jpg'</span>,</span><br><span class="line">      urls: [</span><br><span class="line">        <span class="string">'http://img3.douban.com/view/photo/photo/public/p2152117150.jpg'</span>,</span><br><span class="line">        <span class="string">'http://img5.douban.com/view/photo/photo/public/p1353993776.jpg'</span>,</span><br><span class="line">        <span class="string">'http://img3.douban.com/view/photo/photo/public/p2152134700.jpg'</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 7.2 获取当前地理位置</span></span><br><span class="line">  <span class="built_in">document</span>.querySelector(<span class="string">'#getLocation'</span>).onclick = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    wx.getLocation(&#123;</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">        alert(<span class="built_in">JSON</span>.stringify(res));</span><br><span class="line">      &#125;,</span><br><span class="line">      cancel: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">        alert(<span class="string">'用户拒绝授权获取地理位置'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 9 微信原生接口</span></span><br><span class="line">  <span class="comment">// 9.1.1 扫描二维码并返回结果</span></span><br><span class="line">  <span class="built_in">document</span>.querySelector(<span class="string">'#scanQRCode0'</span>).onclick = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    wx.scanQRCode();</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">wx.error(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">JSON</span>.stringify(res)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="node起服务-server-js"><a href="#node起服务-server-js" class="headerlink" title="node起服务  /server.js"></a>node起服务  /server.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>),</span><br><span class="line">jade = <span class="built_in">require</span>(<span class="string">'jade'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'jade'</span>); <span class="comment">// 设置模板引擎</span></span><br><span class="line">app.set(<span class="string">'views'</span>, <span class="string">'./views'</span>);  <span class="comment">// 设置模板相对路径(相对当前目录)</span></span><br><span class="line"></span><br><span class="line">app.locals.basedir = <span class="string">'./'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> port = <span class="number">4567</span> ;  <span class="comment">//BAE 百度应用引擎默认端口号</span></span><br><span class="line"> <span class="comment">//中间件定义</span></span><br><span class="line">app.use(express.logger());</span><br><span class="line">app.use(express.compress());</span><br><span class="line">app.use(express.bodyParser());</span><br><span class="line">app.use(express.methodOverride());</span><br><span class="line">app.use(express.cookieParser());</span><br><span class="line"></span><br><span class="line"><span class="comment">//静态资源</span></span><br><span class="line"></span><br><span class="line">app.use(express.static(<span class="string">'./static'</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//启动服务</span></span><br><span class="line">app.listen(port, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'服务启动成功！请访问 http://localhost:'</span> + port);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//启动路由分发</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'./router/index'</span>).init(app);</span><br></pre></td></tr></table></figure>
<h4 id="package-json"><a href="#package-json" class="headerlink" title="package.json"></a>package.json</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"wechat-sdk-demo"</span>,</span><br><span class="line">  <span class="string">"version"</span>: <span class="string">"0.0.0"</span>,</span><br><span class="line">  <span class="string">"description"</span>: <span class="string">"a demo with wechat js-sdk based on nodejs"</span>,</span><br><span class="line">  <span class="string">"main"</span>: <span class="string">"server.js"</span>,</span><br><span class="line">  <span class="string">"scripts"</span>: &#123;</span><br><span class="line">    <span class="string">"test"</span>: <span class="string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"repository"</span>: &#123;</span><br><span class="line">    <span class="string">"type"</span>: <span class="string">"git"</span>,</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"https://github.com/liaobin312716/wechat-sdk-demo.git"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"keywords"</span>: [</span><br><span class="line">    <span class="string">"wechat"</span>,</span><br><span class="line">    <span class="string">"js-sdk"</span>,</span><br><span class="line">    <span class="string">"node"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"author"</span>: <span class="string">"liaobin"</span>,</span><br><span class="line">  <span class="string">"license"</span>: <span class="string">"MIT"</span>,</span><br><span class="line">  <span class="string">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="string">"express"</span>: <span class="string">"~3.17.5"</span>,</span><br><span class="line">    <span class="string">"jade"</span>: <span class="string">"^1.11.0"</span>,</span><br><span class="line">    <span class="string">"memory-cache"</span>: <span class="string">"^0.1.4"</span>,</span><br><span class="line">    <span class="string">"request"</span>: <span class="string">"^2.58.0"</span>,</span><br><span class="line">    <span class="string">"sha1"</span>: <span class="string">"^1.1.1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"bugs"</span>: &#123;</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"https://github.com/liaobin312716/wechat-sdk-demo/issues"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"homepage"</span>: <span class="string">"https://github.com/liaobin312716/wechat-sdk-demo"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="router-route-index-js"><a href="#router-route-index-js" class="headerlink" title="router /route/index.js"></a>router /route/index.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">exports.init = <span class="function"><span class="keyword">function</span> (<span class="params">app</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> wechat_cfg = <span class="built_in">require</span>(<span class="string">'../config/wechat.cfg'</span>);</span><br><span class="line">    <span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line">    <span class="keyword">var</span> cache = <span class="built_in">require</span>(<span class="string">'memory-cache'</span>);</span><br><span class="line">    <span class="keyword">var</span> sha1 = <span class="built_in">require</span>(<span class="string">'sha1'</span>); <span class="comment">//签名算法</span></span><br><span class="line">    <span class="comment">// var url = require('url');</span></span><br><span class="line">    <span class="keyword">var</span> signature = <span class="built_in">require</span>(<span class="string">'../sign/signature'</span>);</span><br><span class="line">    </span><br><span class="line">    app.get(<span class="string">'/'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">        <span class="comment">//var url = req.protocol + '://' + req.host + req.path;</span></span><br><span class="line">        <span class="keyword">var</span> url = req.protocol + <span class="string">'://'</span> + req.host + req.originalUrl; <span class="comment">//获取当前url</span></span><br><span class="line">        <span class="built_in">console</span>.log(url);</span><br><span class="line">        signature.sign(url,<span class="function"><span class="keyword">function</span>(<span class="params">signatureMap</span>)</span>&#123;</span><br><span class="line">            signatureMap.appId = wechat_cfg.appid;</span><br><span class="line">            res.render(<span class="string">'index'</span>,signatureMap);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="前端静态资源css-static-index-css"><a href="#前端静态资源css-static-index-css" class="headerlink" title="前端静态资源css /static/index.css"></a>前端静态资源css /static/index.css</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">body&#123;-webkit-tap-highlight-color: rgba(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);&#125;</span><br><span class="line">h3&#123;text-align: center;color: red;&#125;</span><br><span class="line">.panel&#123;text-align: center;&#125;</span><br><span class="line">.panel h5&#123;</span><br><span class="line">    text-align: left;</span><br><span class="line">    color: #888;</span><br><span class="line">    margin: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">.panel button&#123;</span><br><span class="line">    width: <span class="number">90</span>%;</span><br><span class="line">    height: <span class="number">40</span>px;</span><br><span class="line">    line-height: <span class="number">40</span>px;</span><br><span class="line">    margin: <span class="number">5</span>px auto;</span><br><span class="line">    border: none;</span><br><span class="line">    border-radius: <span class="number">5</span>px;</span><br><span class="line">    background: #e2e2e2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="前端静态资源-html-views-index-jade"><a href="#前端静态资源-html-views-index-jade" class="headerlink" title="前端静态资源 html /views/index.jade"></a>前端静态资源 html /views/index.jade</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">doctype html</span><br><span class="line">html(lang=<span class="string">'en'</span>)</span><br><span class="line">    head</span><br><span class="line">        meta(http-equiv=<span class="string">'Content-Type'</span>,content=<span class="string">'text/html; charset=utf-8'</span>)</span><br><span class="line">        meta(name=<span class="string">'viewport'</span>,content=<span class="string">'width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no,minimal-ui'</span>)</span><br><span class="line">        meta(name=<span class="string">'apple-mobile-web-app-status-bar-style'</span>,content=<span class="string">'black'</span>)</span><br><span class="line">        title 微信SDK demo</span><br><span class="line">        link(rel=<span class="string">'stylesheet'</span>,type=<span class="string">"text/css"</span>,href=<span class="string">'index.css'</span>)</span><br><span class="line">    body</span><br><span class="line">        h3 微信SDK demo</span><br><span class="line">        div.panel</span><br><span class="line">            h5 <span class="number">1.</span>判断是否支持特定JS-API</span><br><span class="line">            button#checkJsApi checkJsApi</span><br><span class="line">            br</span><br><span class="line">            br</span><br><span class="line">            h5 <span class="number">2.</span>分享接口</span><br><span class="line">            button#onMenuShareAppMessage 发送给朋友</span><br><span class="line">            br</span><br><span class="line">            br</span><br><span class="line">            h5 <span class="number">3.</span>图像接口</span><br><span class="line">            button#chooseImage 选择图片</span><br><span class="line">            br</span><br><span class="line">            button#previewImage 预览图片</span><br><span class="line">            br</span><br><span class="line">            br</span><br><span class="line">            h5 <span class="number">4.</span>位置接口</span><br><span class="line">            button#getLocation 获取位置</span><br><span class="line">            br</span><br><span class="line">            br</span><br><span class="line">            h5 <span class="number">5.</span>微信扫一扫</span><br><span class="line">            br</span><br><span class="line">            button#scanQRCode0 扫一扫</span><br><span class="line">            br</span><br><span class="line">            button#refresh 刷新当前页面</span><br><span class="line">        script(src=<span class="string">'http://res.wx.qq.com/open/js/jweixin-1.0.0.js'</span>)</span><br><span class="line">        script(type=<span class="string">'text/javascript'</span>).</span><br><span class="line">            <span class="keyword">var</span> signature = <span class="string">'#&#123;signature&#125;'</span>;</span><br><span class="line">            <span class="keyword">var</span> nonceStr = <span class="string">'#&#123;noncestr&#125;'</span>;]</span><br><span class="line">            <span class="keyword">var</span> timestamp = <span class="string">'#&#123;timestamp&#125;'</span>;</span><br><span class="line">            <span class="keyword">var</span> appId = <span class="string">'#&#123;appId&#125;'</span>;</span><br><span class="line">            <span class="keyword">var</span> jsapi_ticket = <span class="string">'#&#123;jsapi_ticket&#125;'</span>;</span><br><span class="line">        script(src=<span class="string">'index.js'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>比较重要的是生成签名的算法，微信官方也给出了各个语言的版本<a href="http://demo.open.weixin.qq.com/jssdk/sample.zip" target="_blank" rel="noopener">示例</a>，<code>java</code>、<code>php</code>、<code>node</code>等。 </p>
<p>参考资料：  </p>
<blockquote>
<p><a href="https://mp.weixin.qq.com/wiki" target="_blank" rel="noopener">微信公众平台技术文档</a><br><a href="http://www.cnblogs.com/albin-gecker/p/4628355.html" target="_blank" rel="noopener">基于nodejs 的微信 JS-SDK 简单应用</a><br><a href="https://mp.weixin.qq.com/debug/" target="_blank" rel="noopener">微信公众平台接口调试工具</a><br><a href="http://203.195.235.76/jssdk/" target="_blank" rel="noopener">jsSDKdemo</a></p>
</blockquote>

  </section>

  <section class="post-comments">

    <!-- 将评论系统（例如Disqus、多说、友言、畅言等）提供的代码片段粘贴在这里 -->
    
</section>


</article>


            <footer class="footer">

    <span class="footer__copyright">&copy; 2014-2015. | 由<a href="https://hexo.io/">Hexo</a>强力驱动 | 主题<a href="https://github.com/someus/huno">Huno</a></span>
    
</footer>
        </div>
    </div>

    <!-- js files -->
    <script src="/js/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/scale.fix.js"></script>
    

    

    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript"> 
        $(document).ready(function(){
            MathJax.Hub.Config({ 
                tex2jax: {inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']]} 
            });
        });
    </script>


    

    <script src="/js/jquery.min.js"></script>
    <script src="/js/awesome-toc.min.js"></script>
    <script>
        $(document).ready(function(){
            $.awesome_toc({
                overlay: true,
                contentId: "post-content",
            });
        });
    </script>


    
    
    <!--kill ie6 -->
<!--[if IE 6]>
  <script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->

</body>
</html>
